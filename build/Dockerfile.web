FROM node:22-alpine AS web-build

WORKDIR /src

COPY web/package.json web/pnpm-lock.yaml ./web/
RUN corepack enable && cd web && pnpm install --frozen-lockfile

COPY web ./web
COPY docs ./docs

RUN cd web && pnpm build && pnpm build:docs

FROM caddy:2.10.2-alpine

COPY deploy/base/caddy/Caddyfile /etc/caddy/Caddyfile
COPY deploy/base/caddy/scalar.html /srv/scalar.html
COPY --from=web-build /src/web/dist /srv

EXPOSE 8081
