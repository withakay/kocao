# Security Review (Baseline)

Date: 2026-02-22

This document captures the baseline security posture of kocao under a hostile private-network assumption.
It is intentionally opinionated and action-oriented; remediation work is tracked as follow-on changes in
module 004 (see Prioritized Remediation).

## System Overview (What We Are Securing)

High-level components:

- Control-plane API (Go, `cmd/control-plane-api`, `internal/controlplaneapi/**`)
  - HTTP API under `/api/v1/*` with a bearer-token + scope model
  - Attach websocket under `/api/v1/sessions/{id}/attach`
  - Audit event store (append-only JSON lines) via `internal/controlplaneapi/audit.go`
- Control-plane operator (Go, `cmd/control-plane-operator`, `internal/operator/**`)
  - Reconciles `Session` and `HarnessRun` CRDs
  - Creates pods and (intended) egress NetworkPolicies per run (`internal/operator/controllers/egress_policy.go`)
- Harness runtime (container executed in pods)
  - Executes user-provided repos/commands, can require git auth secret
- Web UI (React/Vite, `web/**`)
  - Uses bearer token supplied by user and stored in browser `localStorage` (`web/src/ui/auth.tsx`)

Trust boundaries (simplified):

- Browser <-> Control-plane API: hostile network; must be authenticated and rate/abuse resistant
- Control-plane API <-> Kubernetes API: in-cluster credentials; must be least-privilege RBAC
- Operator <-> Kubernetes API: in-cluster credentials; must be least-privilege RBAC
- Attach websocket <-> kube exec: high-risk, interactive capability; must have strong guardrails

## Threat Model

Assumptions:

- Private network is hostile (MITM, SSRF, lateral movement, internal users with curiosity).
- Kubernetes cluster may host multiple workloads; attackers may have network adjacency.
- End users may provide untrusted repo URLs and runtime args.

Primary attacker goals:

- Obtain control-plane bearer tokens / attach tokens
- Use attach to execute arbitrary commands or exfiltrate secrets
- Escalate privileges via over-broad RBAC or operator behavior
- Abuse egress to reach sensitive internal endpoints
- Tamper with/erase audit logs to cover tracks

## Baseline Security Invariants (Contract)

The `security-posture` spec for this module establishes the contract. In practice, the baseline invariants are:

- All `/api/v1/*` endpoints are authenticated (except explicit health/openapi endpoints).
- Authorization decisions are scope-based and auditable.
- Attach websocket is hardened (origin checks, message size limits, timeouts) and tokens are treated as secrets.
- Runtime secrets are not placed in URLs and are provided via Kubernetes Secrets mounted/injected safely.
- Egress is deny-by-default unless explicitly granted.

## Findings (Current State)

Severity key: Critical / High / Medium / Low.

### Critical

1) Attach token is passed in URL query string (token leakage)

- Evidence: `web/src/ui/pages/AttachPage.tsx` constructs
  `.../attach?token=${encodeURIComponent(t.token)}`.
- Evidence: `internal/controlplaneapi/attach.go` reads `r.URL.Query().Get("token")` before header.
- Risk: URL tokens leak via browser history, reverse-proxy logs, referer headers, and diagnostics.
- Fix direction: only allow `Authorization: Bearer <attach-token>` for websocket handshake.

2) Websocket origin check is disabled

- Evidence: `internal/controlplaneapi/attach.go` `wsUpgrader.CheckOrigin` returns `true`.
- Risk: cross-site websocket hijacking if a victim browser can reach the API endpoint.
- Fix direction: strict origin allowlist (configurable), and default-deny in production.

3) No explicit websocket message size limits / timeouts

- Evidence: `internal/controlplaneapi/attach.go` uses `conn.ReadJSON(&m)` without setting
  `SetReadLimit` and without per-connection deadlines.
- Risk: memory pressure, slowloris-style connections, and resource exhaustion.
- Fix direction: size limits, ping/pong deadlines, idle timeouts, bounded queues.

### High

4) Control-plane API is exposed as NodePort without TLS in base manifests

- Evidence: `deploy/base/api-service.yaml` is `type: NodePort` with `nodePort: 30080`.
- Evidence: `cmd/control-plane-api/main.go` uses `ListenAndServe()` (no TLS) and only sets `ReadHeaderTimeout`.
- Risk: token interception, session hijacking, and downgrade attacks if traffic is not terminated with TLS.
- Fix direction: document supported ingress/TLS models; default to in-cluster service + ingress controller TLS.

5) Browser token storage uses `localStorage`

- Evidence: `web/src/ui/auth.tsx` stores bearer token under `kocao.apiToken` in `localStorage`.
- Risk: any XSS can exfiltrate token; browser extensions can read it.
- Fix direction: consider short-lived tokens + in-memory storage; if persistence needed, document risks.

6) Attach token issuance and use is under-specified and not fully audited

- Evidence: token issuance is audited (`attach.token.issued`), but attach websocket connect is not.
- Evidence: `internal/controlplaneapi/attach.go` does not call `a.Audit.Append` on successful/failed connects.
- Risk: reduced incident response value.
- Fix direction: audit attach connect/disconnect, role/lease changes, and backend exec lifecycle.

### Medium

7) RBAC appears incomplete for operator egress enforcement

- Evidence: operator code creates `networking.k8s.io/NetworkPolicy` (`internal/operator/controllers/egress_policy.go`).
- Evidence: `deploy/base/operator-rbac.yaml` does not grant permissions for `networkpolicies`.
- Risk: egress policies may silently fail to apply; runs may default to unrestricted egress depending on cluster.
- Fix direction: fix RBAC + validate at startup; treat inability to enforce egress as an error in restricted mode.

8) Audit log storage is best-effort and unprotected

- Evidence: `internal/controlplaneapi/audit.go` ignores write errors; no rotation; no integrity protection.
- Risk: lost audit events; disk fill; tampering undetected.
- Fix direction: stronger persistence (or explicit constraints), error surfacing, and operational guidance.

9) Bootstrap token has wildcard scope and is configuration-driven

- Evidence: `internal/config/config.go` reads `CP_BOOTSTRAP_TOKEN`.
- Evidence: `internal/controlplaneapi/tokens.go` inserts token with scopes `{"*"}`.
- Risk: broad compromise blast-radius if token is exposed.
- Fix direction: document bootstrap-only usage; enforce `CP_ENV=prod` behavior (disable bootstrap token).

### Low / Hygiene

10) Input validation and limits are minimal in several places

- Examples: `internal/controlplaneapi/api.go` accepts repo URL string with minimal validation;
  attach `ClientID` is caller-provided and reused.
- Risk: log pollution, path issues, and future injection risks.
- Fix direction: normalize and bound inputs; annotate invariants in specs.

## Prioritized Remediation Plan (Maps to Module 004 Changes)

P0 (must address first):

- 004-04_harden-attach-websocket
  - Remove query-string tokens; require Authorization header
  - Enforce origin checks and conservative defaults
  - Add message size limits, deadlines, and backpressure

P1:

- 004-03_harden-api-surface
  - Make authentication mandatory for `/api/v1/*` (explicit allowlist for `/openapi.json`, `/healthz`, `/readyz`)
  - Add request size/time limits; tighten error surfaces
  - Improve attach/audit endpoint audit coverage

- 004-02_fix-audit-config-and-rbac
  - Fix operator RBAC (NetworkPolicy permissions, least-privilege)
  - Fix audit configuration and ensure audits are durable/visible

P2:

- 004-05_operator-egress-alignment
  - Ensure restricted egress is actually enforced for runs
  - Document/validate GitHub CIDR configuration and DNS assumptions

- 004-06_web-ui-security-hardening
  - Reduce token exposure in the browser (storage strategy)
  - Add UI guardrails (explicit warnings for driver role, token handling)

- 004-07_harden-harness-runtime
  - Harden runtime environment (filesystem, credentials, process execution constraints)

## Static Analysis / Tooling Notes

- Baseline CI should include `make lint` (gofmt check + go vet) and `make test`.
- A GitHub Actions workflow is provided at `.github/workflows/ci.yml` to run Go and web lint/tests on PRs.
- `gosec` is not enabled in CI in this change. It is valuable, but it typically requires tuning (exclude rules,
  triage suppressions) and should be introduced once we have a stable baseline to avoid alert fatigue.

## Status vs Security Posture Spec

See `.ito/changes/004-01_baseline-security-review/specs/security-posture/spec.md`.
This change establishes the contract and documents the current gaps; follow-on changes close them.
